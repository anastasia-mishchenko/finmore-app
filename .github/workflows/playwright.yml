name: Playwright Tests with Allure
 
on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:
 
jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
 
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
 
      - name: Install dependencies
        run: npm ci
 
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
 
      - name: Run Playwright tests
        id: playwright-tests
        env:
          CI: true
        run: |
          npx playwright test --reporter=json:test-results.json --reporter=line --reporter=allure-playwright 2>&1 | tee test-output.txt
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          exit $TEST_EXIT_CODE
        continue-on-error: true
 
      - name: Remove existing Allure report
        if: always()
        run: |
          rm -rf ./allure-report
     
      - name: Generate Allure report
        if: always()
        run: |
          npx allure generate ./allure-results -o ./allure-report
 
     
      - name: Upload Allure report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report
 
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report

      - name: Parse test results
        if: always()
        id: test-results
        run: |
          PASSED=0
          FAILED=0
          SKIPPED=0
          DURATION_MS=0
          
          # Method 1: Parse from JSON file (most accurate)
          if [ -f test-results.json ]; then
            # Count tests by status - traverse suites -> specs -> tests
            PASSED=$(jq -r '[.suites[].specs[].tests[]? | select(.status == "passed")] | length' test-results.json 2>/dev/null || echo "0")
            FAILED=$(jq -r '[.suites[].specs[].tests[]? | select(.status == "failed")] | length' test-results.json 2>/dev/null || echo "0")
            SKIPPED=$(jq -r '[.suites[].specs[].tests[]? | select(.status == "skipped")] | length' test-results.json 2>/dev/null || echo "0")
            DURATION_MS=$(jq -r '.stats.duration // 0' test-results.json 2>/dev/null || echo "0")
          fi
          
          # Method 2: Parse from console output (reliable fallback)
          if [ -f test-output.txt ] && ([ "$PASSED" = "0" ] || [ -z "$PASSED" ]); then
            # Playwright's line reporter shows: "X passed" or "X passed, Y failed" at the end
            # Look for lines with test counts
            if [ "$PASSED" = "0" ] && [ "$FAILED" = "0" ]; then
              # Try to find summary lines - Playwright prints them at the end
              PASSED=$(grep -oE '^\s*[0-9]+\s+passed' test-output.txt | tail -1 | grep -oE '[0-9]+' || echo "0")
              FAILED=$(grep -oE '^\s*[0-9]+\s+failed' test-output.txt | tail -1 | grep -oE '[0-9]+' || echo "0")
              SKIPPED=$(grep -oE '^\s*[0-9]+\s+skipped' test-output.txt | tail -1 | grep -oE '[0-9]+' || echo "0")
              
              # Alternative: look for combined summary line like "5 passed (30s)"
              if [ "$PASSED" = "0" ] && [ "$FAILED" = "0" ]; then
                SUMMARY=$(grep -E '[0-9]+\s+passed' test-output.txt | tail -1 || echo "")
                if [ -n "$SUMMARY" ]; then
                  PASSED=$(echo "$SUMMARY" | grep -oE '[0-9]+' | head -1 || echo "0")
                fi
                SUMMARY=$(grep -E '[0-9]+\s+failed' test-output.txt | tail -1 || echo "")
                if [ -n "$SUMMARY" ]; then
                  FAILED=$(echo "$SUMMARY" | grep -oE '[0-9]+' | head -1 || echo "0")
                fi
              fi
            fi
          fi
          
          # Ensure valid integers (default to 0 if empty)
          PASSED=$((PASSED + 0))
          FAILED=$((FAILED + 0))
          SKIPPED=$((SKIPPED + 0))
          DURATION_MS=$((DURATION_MS + 0))
          
          # Calculate total
          TOTAL=$((PASSED + FAILED + SKIPPED))
          
          # Format duration
          if [ "$DURATION_MS" -gt 0 ]; then
            DURATION_SEC=$((DURATION_MS / 1000))
            DURATION_MIN=$((DURATION_SEC / 60))
            DURATION_REMAINING_SEC=$((DURATION_SEC % 60))
            if [ "$DURATION_MIN" -gt 0 ]; then
              DURATION_FORMATTED="${DURATION_MIN}m ${DURATION_REMAINING_SEC}s"
            else
              DURATION_FORMATTED="${DURATION_SEC}s"
            fi
          else
            DURATION_FORMATTED="N/A"
          fi
          
          echo "Test Results: Passed=${PASSED}, Failed=${FAILED}, Skipped=${SKIPPED}, Total=${TOTAL}"
          
          echo "passed=${PASSED}" >> $GITHUB_OUTPUT
          echo "failed=${FAILED}" >> $GITHUB_OUTPUT
          echo "skipped=${SKIPPED}" >> $GITHUB_OUTPUT
          echo "total=${TOTAL}" >> $GITHUB_OUTPUT
          echo "duration_formatted=${DURATION_FORMATTED}" >> $GITHUB_OUTPUT

      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        if: always() # CRITICAL: This ensures it runs even if the tests fail
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: |
            *Playwright Test Results*
            
            *Repository:* ${{ github.repository }}
            *Branch:* ${{ github.ref_name }}
            *Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}> by ${{ github.actor }}
            *Workflow:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>
            
            *Test Results:*
            üìä Total: ${{ steps.test-results.outputs.total }}
            ‚úÖ Passed: ${{ steps.test-results.outputs.passed }}
            ‚ùå Failed: ${{ steps.test-results.outputs.failed }}
            ‚è≠Ô∏è  Skipped: ${{ steps.test-results.outputs.skipped }}
            ‚è±Ô∏è  Duration: ${{ steps.test-results.outputs.duration_formatted }}
            
            *Status:* ${{ job.status == 'success' && '‚úÖ SUCCESS' || '‚ùå FAILURE' }}
          SLACK_TITLE: Playwright Test Run - ${{ github.ref_name }}    