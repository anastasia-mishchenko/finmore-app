name: Playwright Tests with Allure
 
on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:
 
jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
 
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
 
      - name: Install dependencies
        run: npm ci
 
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
 
      - name: Run Playwright tests
        id: playwright-tests
        env:
          CI: true
        run: |
          npx playwright test --reporter=json:test-results.json --reporter=line --reporter=allure-playwright || TEST_EXIT_CODE=$?
          exit ${TEST_EXIT_CODE:-0}
        continue-on-error: true
 
      - name: Remove existing Allure report
        if: always()
        run: |
          rm -rf ./allure-report
     
      - name: Generate Allure report
        if: always()
        run: |
          npx allure generate ./allure-results -o ./allure-report
 
     
      - name: Upload Allure report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report
 
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report

      - name: Parse test results
        if: always()
        id: test-results
        run: |
          if [ -f test-results.json ]; then
            # Parse Playwright JSON reporter output
            # Count passed tests (status: "passed" or ok: true)
            PASSED=$(jq -r '[.suites[]?.specs[]?.tests[]? | select(.status == "passed" or .ok == true)] | length' test-results.json 2>/dev/null || echo "0")
            # Count failed tests
            FAILED=$(jq -r '[.suites[]?.specs[]?.tests[]? | select(.status == "failed" or .ok == false)] | length' test-results.json 2>/dev/null || echo "0")
            # Count skipped tests
            SKIPPED=$(jq -r '[.suites[]?.specs[]?.tests[]? | select(.status == "skipped")] | length' test-results.json 2>/dev/null || echo "0")
            # Get duration in milliseconds
            DURATION_MS=$(jq -r '.stats.duration // (.suites[].duration // 0 | add) // 0' test-results.json 2>/dev/null || echo "0")
          else
            # Fallback values
            PASSED=0
            FAILED=0
            SKIPPED=0
            DURATION_MS=0
          fi
          
          # Calculate total tests
          TOTAL=$((PASSED + FAILED + SKIPPED))
          
          # Format duration (convert ms to seconds, then format)
          if [ -z "$DURATION_MS" ] || [ "$DURATION_MS" = "null" ] || [ "$DURATION_MS" = "0" ]; then
            DURATION_FORMATTED="N/A"
          else
            DURATION_SEC=$((DURATION_MS / 1000))
            DURATION_MIN=$((DURATION_SEC / 60))
            DURATION_REMAINING_SEC=$((DURATION_SEC % 60))
            if [ "$DURATION_MIN" -gt 0 ]; then
              DURATION_FORMATTED="${DURATION_MIN}m ${DURATION_REMAINING_SEC}s"
            else
              DURATION_FORMATTED="${DURATION_SEC}s"
            fi
          fi
          
          echo "passed=${PASSED}" >> $GITHUB_OUTPUT
          echo "failed=${FAILED}" >> $GITHUB_OUTPUT
          echo "skipped=${SKIPPED}" >> $GITHUB_OUTPUT
          echo "total=${TOTAL}" >> $GITHUB_OUTPUT
          echo "duration_formatted=${DURATION_FORMATTED}" >> $GITHUB_OUTPUT

      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        if: always() # CRITICAL: This ensures it runs even if the tests fail
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: |
            *Playwright Test Results*
            
            *Repository:* ${{ github.repository }}
            *Branch:* ${{ github.ref_name }}
            *Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}> by ${{ github.actor }}
            *Workflow:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>
            
            *Test Results:*
            üìä Total: ${{ steps.test-results.outputs.total }}
            ‚úÖ Passed: ${{ steps.test-results.outputs.passed }}
            ‚ùå Failed: ${{ steps.test-results.outputs.failed }}
            ‚è≠Ô∏è  Skipped: ${{ steps.test-results.outputs.skipped }}
            ‚è±Ô∏è  Duration: ${{ steps.test-results.outputs.duration_formatted }}
            
            *Status:* ${{ job.status == 'success' && '‚úÖ SUCCESS' || '‚ùå FAILURE' }}
          SLACK_TITLE: Playwright Test Run - ${{ github.ref_name }}    